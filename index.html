<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ææˆå·¥è³‡ç®¡ç†å¹³å° </title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <style>
        /* --- General Styles & Fonts --- */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');
        
        :root {
            --bg-dark: #1a1d24;
            --bg-light: #242832;
            --border-color: #333947;
            --text-primary: #EAEAEA;
            --text-secondary: #a0a9b8;
            --accent-primary: #007BFF;
            --accent-hover: #0056b3;
            --hitachi-red: #e60012;
            --shadow-color: rgba(0, 0, 0, 0.2);

            --status-unconfirmed-bg: #4a4a28;
            --status-unconfirmed-text: #f0e68c;
            --status-confirmed-bg: #1e4d2b;
            --status-confirmed-text: #a7d7b5;
            --status-abnormal-bg: #5c2c2c;
            --status-abnormal-text: #f4c2c2;
            --status-modification-bg: #3a2d5c;
            --status-modification-text: #d9c8f5;

            --change-old-text: #f4c2c2;
            --change-new-text: #a7d7b5;

            --transition-speed: 0.3s;
        }

        body.light-mode {
            --bg-dark: #f4f6f9;
            --bg-light: #ffffff;
            --border-color: #e0e0e0;
            --text-primary: #333;
            --text-secondary: #6c757d;
            --shadow-color: rgba(0, 0, 0, 0.05);

            --status-unconfirmed-bg: #fff0c2;
            --status-unconfirmed-text: #8c6c00;
            --status-confirmed-bg: #c8e6c9;
            --status-confirmed-text: #256029;
            --status-abnormal-bg: #ffcdd2;
            --status-abnormal-text: #c62828;
            --status-modification-bg: #d1c4e9;
            --status-modification-text: #4527a0;
            
            --change-old-text: #c62828;
            --change-new-text: #256029;
        }

        body, html { 
            margin: 0; padding: 0; font-family: 'Noto Sans SC', 'Helvetica Neue', Helvetica, Arial, sans-serif; background-color: var(--bg-dark); color: var(--text-primary); height: 100%; font-size: 14px;
            transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
        }

        .container { display: flex; height: 100vh; transition: all var(--transition-speed) ease; }
        .sidebar { width: 240px; background-color: var(--bg-light); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; padding-top: 20px; flex-shrink: 0; transition: all var(--transition-speed) ease; }
        .main-content { flex-grow: 1; display: flex; flex-direction: column; overflow-y: auto; }

        .header { display: flex; justify-content: space-between; align-items: center; padding: 10px 30px; background-color: var(--bg-light); border-bottom: 1px solid var(--border-color); height: 60px; box-sizing: border-box; flex-shrink: 0; transition: background-color var(--transition-speed) ease, border-color var(--transition-speed) ease; }
        .header .user-info { display: flex; align-items: center; gap: 15px; font-size: 14px; color: var(--text-secondary); flex-wrap: wrap; }
        .header .user-info .role-area { display: flex; align-items: center; gap: 10px;}
        .header .user-info #user-name { color: var(--text-primary); font-weight: 500;}

        .view-mode-switcher, .theme-switcher { display: flex; align-items: center; cursor: pointer; }
        .view-mode-switcher .icon { width: 24px; height: 24px; color: var(--text-secondary); }
        .view-mode-switcher .icon:hover { color: var(--text-primary); }
        #desktop-icon { display: none; }
        .theme-switcher input { display: none; }
        .theme-switcher .slider { width: 50px; height: 26px; background-color: #3e4450; border-radius: 13px; position: relative; transition: background-color var(--transition-speed) ease; }
        .theme-switcher .slider:before { content: ''; position: absolute; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: transform var(--transition-speed) ease; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%231a1d24"><path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.106a.75.75 0 00-1.06-1.06l-1.591 1.59a.75.75 0 101.06 1.061l1.591-1.59zM21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5H21a.75.75 0 01.75.75zM17.836 17.894a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 10-1.061 1.06l1.59 1.591zM12 18a.75.75 0 01.75.75V21a.75.75 0 01-1.5 0v-2.25A.75.75 0 0112 18zM7.894 17.836a.75.75 0 00-1.06-1.061l-1.591 1.59a.75.75 0 101.06 1.06l1.591-1.59zM3 12a.75.75 0 01-.75.75H.75a.75.75 0 010-1.5h2.25A.75.75 0 013 12zM6.106 6.106a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 00-1.061 1.06l1.59 1.591z" /></svg>'); background-size: 14px; background-repeat: no-repeat; background-position: center; }
        .theme-switcher input:checked + .slider { background-color: var(--accent-primary); }
        .theme-switcher input:checked + .slider:before { transform: translateX(24px); background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%231a1d24"><path d="M21.75 12.016a9.72 9.72 0 01-9.72 9.72A9.72 9.72 0 012.25 12.016a9.72 9.72 0 019.72-9.72 9.72 9.72 0 019.78 9.72zM12 3.25A8.75 8.75 0 1012 20.75 8.75 8.75 0 0012 3.25z" /></svg>'); }

        .logo { padding: 0 25px 20px 25px; border-bottom: 1px solid var(--border-color); }
        .logo img { width: 100px; transition: all var(--transition-speed) ease; }
        .nav-menu { list-style: none; padding: 20px 0; margin: 0; flex-grow: 1; }
        .nav-menu li { padding: 15px 25px; cursor: pointer; font-size: 15px; color: var(--text-secondary); display: flex; align-items: center; transition: all 0.2s ease; border-left: 3px solid transparent; overflow: hidden; white-space: nowrap; }
        .nav-menu li.active, .nav-menu li:hover { background-color: rgba(0, 123, 255, 0.1); color: var(--text-primary); border-left-color: var(--accent-primary); }
        .nav-menu li svg { margin-right: 15px; width: 20px; height: 20px; fill: currentColor; flex-shrink: 0; }
        .nav-menu li span { transition: opacity var(--transition-speed) ease; }
        .nav-menu li.specialist-only, .nav-menu li.employee-only { display: none; }

        .page { display: none; padding: 30px 40px; transition: padding var(--transition-speed) ease; }
        .page.active { display: block; animation: fadeIn 0.5s; }
        .page h1 { font-size: 28px; font-weight: 500; color: var(--text-primary); margin-top: 0; margin-bottom: 25px; transition: font-size var(--transition-speed) ease; }
        .page p { color: var(--text-secondary); line-height: 1.6; }
        .page .page-description { font-size: 16px; max-width: 800px; margin-bottom: 30px;}

        .card { background: var(--bg-light); padding: 25px; border-radius: 8px; border: 1px solid var(--border-color); margin-bottom: 25px; transition: background-color var(--transition-speed) ease, border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease; }
        body.light-mode .card { box-shadow: 0 4px 6px -1px var(--shadow-color), 0 2px 4px -2px var(--shadow-color); }
        .card-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); }
        .card-header h2 { margin: 0; font-size: 18px; font-weight: 500; color: var(--text-primary); }
        .page-actions { margin-bottom: 25px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .page-actions .filters { display: flex; gap: 15px; align-items: center; flex-grow: 1; flex-wrap: wrap;}
        .page-actions .filters .filter-group { display: flex; align-items: center; gap: 8px; color: var(--text-secondary); }
        .page-actions .action-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        
        input, select, textarea { background-color: var(--bg-dark); border: 1px solid var(--border-color); color: var(--text-primary); padding: 10px 15px; font-size: 14px; border-radius: 6px; transition: all var(--transition-speed) ease; box-sizing: border-box; width: 100%; }
        textarea { font-family: 'Noto Sans SC', sans-serif; }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: var(--bg-dark) > #fff ? invert(1) : invert(0); cursor: pointer; }
        body.light-mode input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0); }
        body.dark-mode input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2); }

        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        td, th { padding: 15px; text-align: left; vertical-align: middle; }
        td { color: var(--text-secondary); }
        th { font-weight: 500; color: var(--text-primary); border-bottom: 2px solid var(--border-color); }
        tbody tr { border-bottom: 1px solid var(--border-color); transition: background-color 0.2s ease;}
        tbody tr:last-child { border-bottom: none; }
        tbody tr:not(.no-hover, .sub-row) { cursor: pointer; }
        tbody tr:not(.no-hover, .sub-row):hover { background-color: rgba(0, 123, 255, 0.05); }
        
        .sub-row { display: none; }
        .sub-row.visible { display: table-row; animation: fadeIn 0.4s; }
        .sub-row > td { background-color: var(--bg-dark); padding: 20px 30px; box-shadow: inset 0 6px 6px -6px var(--shadow-color); }
        .sub-row-content { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; }
        .sub-row-content h4 { grid-column: 1 / -1; margin-top: 0; color: var(--accent-primary); border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 10px; font-weight: 500;}
        .sub-row-content h5 { font-size: 14px; color: var(--text-primary); margin-top: 0; margin-bottom: 10px; }
        .sub-row-content p { margin: 0 0 8px 0; color: var(--text-secondary); }
        .sub-row-content p strong { color: var(--text-primary); min-width: 80px; display: inline-block; }
        .main-row.parent-row-active { background-color: rgba(0, 123, 255, 0.1); }
        .main-row .arrow-icon { display: inline-block; transition: transform 0.3s ease; margin-left: 8px; font-size: 12px; }
        .main-row.parent-row-active .arrow-icon { transform: rotate(90deg); }
        .change-old { color: var(--change-old-text); text-decoration: line-through; }
        .change-new { color: var(--change-new-text); font-weight: bold; }
        .change-item { margin-bottom: 5px; }

        .status { padding: 5px 12px; border-radius: 15px; font-size: 12px; font-weight: 500; display: inline-block; white-space: nowrap; border: 1px solid; }
        .status-unconfirmed { background-color: var(--status-unconfirmed-bg); color: var(--status-unconfirmed-text); border-color: var(--status-unconfirmed-text); }
        .status-confirmed { background-color: var(--status-confirmed-bg); color: var(--status-confirmed-text); border-color: var(--status-confirmed-text);}
        .status-abnormal { background-color: var(--status-abnormal-bg); color: var(--status-abnormal-text); border-color: var(--status-abnormal-text);}
        .status-modification { background-color: var(--status-modification-bg); color: var(--status-modification-text); border-color: var(--status-modification-text);}
        
        .btn { padding: 10px 20px; border: 1px solid transparent; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 8px; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px var(--shadow-color); }
        .btn:active { transform: translateY(0); }
        .btn-primary { background-color: var(--accent-primary); color: white; border-color: var(--accent-primary); }
        .btn-primary:hover { background-color: var(--accent-hover); border-color: var(--accent-hover); }
        .btn-secondary { background-color: #4a5464; color: var(--text-primary); border-color: #4a5464;}
        .btn-secondary:hover { background-color: #5e6a7e; }
        body.light-mode .btn-secondary { background-color: #e2e6ea; color: #333; border-color: #dae0e5; }
        body.light-mode .btn-secondary:hover { background-color: #d3d9df; }
        .btn-outline { background-color: transparent; border: 1px solid var(--border-color); color: var(--text-primary); }
        .btn-outline:hover { background-color: var(--accent-primary); color: white; border-color: var(--accent-primary);}
        .btn-sm { padding: 5px 12px; font-size: 12px; }

        .tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; }
        .tab-link { padding: 10px 20px; cursor: pointer; color: var(--text-secondary); border-bottom: 3px solid transparent; margin-bottom: -1px; transition: all 0.2s ease; }
        .tab-link.active { color: var(--accent-primary); border-bottom-color: var(--accent-primary); font-weight: 500; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(5px); animation: fadeIn 0.3s; }
        .modal-content { background-color: var(--bg-light); margin: 8% auto; padding: 30px; border: 1px solid var(--border-color); width: 60%; max-width: 800px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); animation: slideIn 0.4s; transition: all var(--transition-speed) ease; }
        body.light-mode .modal { background-color: rgba(255, 255, 255, 0.5); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 25px; }
        .modal-header h2 { margin: 0; font-size: 22px; color: var(--text-primary);}
        .close-btn { color: var(--text-secondary); font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.2s; }
        .close-btn:hover { color: var(--text-primary); }
        .modal-body { max-height: 60vh; overflow-y: auto; padding-right: 15px;}
        .modal-footer { padding-top: 25px; margin-top: 25px; border-top: 1px solid var(--border-color); text-align: right; }
        .modal-footer .btn { margin-left: 10px; }
        .form-group, .detail-group { margin-bottom: 20px; }
        .form-group label, .detail-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); font-size: 14px;}
        .detail-group p { margin: 0; padding: 12px 15px; background: var(--bg-dark); border-radius: 6px; min-height: 21px; font-size: 14px; line-height: 1.5; border: 1px solid var(--border-color); }
        
        .logic-editor-container { display: flex; gap: 20px; }
        .logic-editor { flex: 2; }
        .logic-editor textarea { height: 250px; font-family: monospace; font-size: 14px; line-height: 1.6; }
        .logic-help { flex: 1; background-color: var(--bg-dark); padding: 15px; border-radius: 6px; border: 1px solid var(--border-color); }
        .logic-help h5 { margin-top: 0; }
        .logic-help ul { padding-left: 20px; margin-bottom: 0; }

        .qr-scanner-container { text-align: center; padding: 50px 20px; }
        .qr-scanner-container .icon { font-size: 80px; color: var(--accent-primary); margin-bottom: 20px; }
        .qr-scan-result { margin-top: 30px; text-align: left; max-width: 400px; margin-left: auto; margin-right: auto;}
        
        .allocation-row { display: flex; align-items: center; gap: 15px; margin-bottom: 10px !important; }
        .allocation-row span { flex-basis: 120px; }
        .allocation-row input { flex-grow: 1; }
        .allocation-row .btn { flex-shrink: 0; }
        #manage-participants .allocation-row { margin-top: 15px; }
        #alloc-total { font-weight: bold; margin-left: 20px;}

        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }
        @keyframes slideIn { from {transform: translateY(-50px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }

        /* --- MOBILE VIEW STYLES --- */
        body.mobile-view .sidebar { width: 65px; }
        body.mobile-view .sidebar .logo img { width: 35px; margin: 0 auto; display: block; }
        body.mobile-view .sidebar .nav-menu li { padding-left: 22px; }
        body.mobile-view .sidebar .nav-menu li span { opacity: 0; width: 0; }
        body.mobile-view .header { padding: 10px 15px; }
        body.mobile-view .header .user-info { gap: 10px; flex-wrap: wrap; justify-content: flex-end;}
        body.mobile-view .page { padding: 15px 20px; }
        body.mobile-view .page h1 { font-size: 22px; }
        body.mobile-view .page-actions, body.mobile-view .page-actions .filters { flex-direction: column; align-items: stretch; gap: 10px; }
        body.mobile-view .page-actions .action-buttons { justify-content: flex-start; }
        body.mobile-view .filter-group, body.mobile-view .filter-group input, body.mobile-view .filter-group select { width: 100%; box-sizing: border-box; }
        body.mobile-view .modal-content { width: 95%; max-width: 95%; margin: 5% auto; padding: 20px; }
        body.mobile-view table { border: 0; }
        body.mobile-view table thead { display: none; }
        body.mobile-view table tr:not(.sub-row) { display: block; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 0; border-bottom-left-radius: 0; border-bottom-right-radius: 0; padding: 15px; background-color: var(--bg-dark); }
        body.mobile-view tr.sub-row { display: none; border: 1px solid var(--border-color); border-top: 0; margin-bottom: 15px; border-top-left-radius: 0; border-top-right-radius: 0; }
        body.mobile-view tr.sub-row.visible { display: block; }
        body.mobile-view table td { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; text-align: right; border-bottom: 1px solid var(--border-color); }
        body.mobile-view table tr:not(.sub-row) td:last-child { border-bottom: 0; }
        body.mobile-view table td::before { content: attr(data-label); font-weight: 500; color: var(--text-primary); text-align: left; margin-right: 15px; }
        body.mobile-view table td:has(input[type="checkbox"]) { padding: 10px 0; border: 0; justify-content: flex-end; }
        body.mobile-view table td:has(input[type="checkbox"])::before { content: none; }
        body.mobile-view .sub-row-content { grid-template-columns: 1fr; }
        body.mobile-view .logic-editor-container { flex-direction: column; }
        
        /* --- æ–°å¢ä»£ç å¼€å§‹ --- */
        .page-header-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px; }
        .analysis-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .analysis-grid .card { grid-column: span 1; }
        .analysis-grid .full-width { grid-column: 1 / -1; }
        .report-section h3 { font-size: 16px; color: var(--accent-primary); margin-top:0; padding-bottom:10px; border-bottom: 1px solid var(--border-color); }
        .report-section p { margin-bottom: 15px; }
        .report-section strong { color: var(--text-primary); }
        .report-section .positive { color: var(--change-new-text); }
        .report-section .negative { color: var(--change-old-text); }

        .chart-container { position: relative; height: 300px; width: 100%; }
        
        #powerbi-modal .modal-content { max-width: 1200px; width: 90%; }
        .powerbi-view { display: flex; gap: 20px; }
        .powerbi-view .fields-panel { flex: 0 0 250px; background-color: var(--bg-dark); padding: 15px; border-radius: 6px; border: 1px solid var(--border-color); }
        .powerbi-view .fields-panel h4 { margin-top: 0; margin-bottom: 15px; color: var(--text-primary); }
        .powerbi-view .fields-panel .field-group { margin-bottom: 10px; }
        .powerbi-view .fields-panel .field-group label { display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .powerbi-view .fields-panel .field-group input { width: auto; }
        .powerbi-view .chart-panel { flex-grow: 1; }
        /* --- æ–°å¢ä»£ç ç»“æŸ --- */

    </style>
</head>
<body>

    <div class="container">
        <div class="sidebar">
            <div class="logo"><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMjAgMzUiPjxwYXRoIGZpbGw9IiNFNjAwMTIiIGQ9Ik0xMy4zIDM0LjFoNy40di05LjZoLTMuN2wtMi4xIDUuMy0yLjEtNS4zaC0zLjh2OS42aDQuMnYtNC41bDIuMSA1LjJ6bTguMS0xMy45aDQuM3YxMy45aDQuM3YtMTguNWgtMTN2NC42aDQuNHptMTAuMiAxMy45aDQuM3YtMTguNWgtNC4zdjE4LjV6bTkuOCAwdi0xMy45aDkuNHYtNC42aC0xMy43djE4LjVoNC4zem0xMS4yLTE4LjVoNC4zdjEzLjloNC4zdi0xOC41aC0xM3Y0LjZoNC40em0yMS4yIDkuNmgtMy43bC0yLjEgNS4zLTIuMS01LjzaC0zLjh2OS42aDQuMnYtNC41bDIuMSA1LjJoMy45bDIuMS01LjJ2NC41aDQuMnYtOS42aC0zLjd6bTguMS05LjZoNC4zdjE4LjVoLTQuM3YtMTh6bTkuMiAwaDQuM3YxMy45aDQuM3YtMTguNWgtMTN2NC42aDQuNHptMTMuMSAwYzIuNCAwIDQuMyAxLjkgNC4zIDQuM3MtMS45IDQuMy00LjyNC4zaC00LjJ2NS4zaDQuMnY0LjZoLTguNXYtMThoNC4zem0wIDQuNmgtMy44YzEuNyAwIDIuOC0xLjEgMi44LTIuOHMtMS4xLTIuNy0yLjgtMi43aC0uM3Y1JTUeiIvPjwvc3ZnPg==" alt="HITACHI Logo"></div>
            <ul class="nav-menu">
                <li class="active" data-page="home" title="é¦–é¡µ"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"></path></svg><span>é¦–é¡µ</span></li>
                <li data-page="clock-in" class="employee-only" title="æ‰«ç æ‰“å¡"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 11h8V3H3v8zm2-6h4v4H5V5zM3 21h8v-8H3v8zm2-6h4v4H5v-4zM13 3v8h8V3h-8zm6 6h-4V5h4v4zM13 21h8v-8h-8v8zm2-6h4v4h-4v-4z"></path></svg><span>æ‰«ç¢¼æ‰“å¡</span></li>
                <li data-page="allocation" title="ä¸šåŠ¡åˆ†é…ä¸ç¡®è®¤"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"></path></svg><span>ä¸šåŠ¡åˆ†é…ä¸ç¡®è®¤</span></li>
                <li data-page="modification-processing" title="ä¿®æ”¹ç”³è¯·è¿½è¸ª"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"></path></svg><span>ä¿®æ”¹ç”³è¯·è¿½è¸ª</span></li>
                <li data-page="employee-requests-approval" class="specialist-only" title="å‘˜å·¥ç”³è¯·å®¡æ‰¹"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1s-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm7 15H5V5h14v14zM12 16l-4-4h8l-4 4z"></path></svg><span>å‘˜å·¥ç”³è¯·å®¡æ‰¹</span></li>
                <li data-page="calculation-results" class="specialist-only" title="æ ¸ç®—ç»“æœ"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-4h2v4zm4 0h-2v-7h2v7zm4 0h-2V7h2v10z"></path></svg><span>æ ¸ç®—ç»“æœ</span></li>
                <li data-page="calculation-analysis" class="specialist-only" title="æ ¸ç®—åˆ†æ"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zM11 7h2v6h-2zm0 8h2v2h-2z"></path></svg><span>æ ¸ç®—åˆ†æ</span></li>
                <li data-page="rules-engine" class="specialist-only" title="æ ¸ç®—è§„åˆ™è®¾ç½®"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"></path></svg><span>æ ¸ç®—è§„åˆ™è®¾ç½®</span></li>
             </ul>
        </div>

        <div class="main-content">
            <div class="header">
                  <div></div>
                <div class="user-info">
                    <div class="view-mode-switcher" id="view-mode-toggle" title="åˆ‡æ¢è§†å›¾">
                        <svg id="mobile-icon" class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M17 1.01L7 1c-1.1 0-2 .9-2 2v18c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V3c0-1.1-.9-1.99-2-1.99zM17 19H7V5h10v14z"></path></svg>
                        <svg id="desktop-icon" class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M21 2H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h7v2H8v2h8v-2h-2v-2h7c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H3V4h18v12z"></path></svg>
                    </div>
                    <label class="theme-switcher">
                        <input type="checkbox" id="theme-toggle">
                        <span class="slider"></span>
                    </label>
                    <div class="role-area">
                         <select id="commission-type-switcher">
                            <option value="maintenance_ops">ç»´ä¿ä½œä¸šè®¡æ</option>
                            <option value="maintenance_biz">ç»´ä¿ä¸šåŠ¡è®¡æ</option>
                        </select>
                    </div>
                    <div class="role-area">
                        <select id="role-switcher">
                            <option value="specialist">æ ¸ç®—ä¸“å‘˜</option>
                            <option value="employee_E001" selected>æ™®é€šå‘˜å·¥ (å¼ ä¸‰)</option>
                            <option value="employee_E002">æ™®é€šå‘˜å·¥ (æå››)</option>
                        </select>
                    </div>
                    <span><span id="user-name"></span></span>
                </div>
            </div>
            <div id="page-home" class="page active"><h1>æ¬¢è¿æ¥åˆ°ææˆå·¥èµ„ç®¡ç†å¹³å°</h1><p class="page-description">è¿™æ˜¯ä¸€ä¸ªä¸ºç°ä»£åŒ–å·¥ä½œæµç¨‹è®¾è®¡çš„åŠŸèƒ½åŸå‹ã€‚æ‚¨å¯ä»¥ä½¿ç”¨å³ä¸Šè§’çš„è§’è‰²åˆ‡æ¢å™¨æ¥ä½“éªŒæ ¸ç®—ä¸“å‘˜å’Œæ™®é€šå‘˜å·¥çš„ä¸åŒæ“ä½œè§†è§’å’Œæƒé™ã€‚æ–°å¢çš„è§†å›¾åˆ‡æ¢æŒ‰é’®å¯ä»¥æ¨¡æ‹Ÿæ‰‹æœºç«¯æµè§ˆæ•ˆæœã€‚</p></div>
            <div id="page-clock-in" class="page">
                <h1>æ‰«ç æ‰“å¡</h1>
                <p class="page-description">è¯·å°†æ‘„åƒå¤´å¯¹å‡†ç”µæ¢¯å†…çš„äºŒç»´ç è¿›è¡Œæ‰«æï¼Œä»¥è®°å½•æ‚¨çš„ç°åœºä½œä¸šä¿¡æ¯ã€‚</p>
                <div class="card">
                    <div class="qr-scanner-container">
                        <div class="icon">ğŸ“·</div>
                        <button class="btn btn-primary btn-lg" onclick="simulateScan()">æ¨¡æ‹Ÿæ‰«æç”µæ¢¯ç </button>
                        <div id="qr-scan-result-container" class="qr-scan-result" style="display: none;">
                             <div class="card-header"><h2>æ‰«æç»“æœ</h2></div>
                            <div class="detail-group"><label>ç”µæ¢¯ID</label><p id="qr-elevator-id"></p></div>
                            <div class="detail-group"><label>ä½ç½®</label><p id="qr-elevator-location"></p></div>
                            <button class="btn btn-secondary" onclick="confirmClockIn()">ç¡®è®¤æ‰“å¡</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="page-allocation" class="page">
                <h1>ä¸šåŠ¡åˆ†é…ä¸ç¡®è®¤</h1>
                <div id="allocation-tabs-container"></div>
                <div id="allocation-powerbi-container"></div>
                <div class="page-actions" id="allocation-page-actions"></div>
                <div class="card">
                    <div class="card-header"><h2 id="allocation-table-title">ä¸šåŠ¡åˆ—è¡¨</h2></div>
                    <table id="allocation-table"><thead></thead><tbody></tbody></table>
                </div>
            </div>
            <div id="page-modification-processing" class="page">
                <h1>ä¿®æ”¹ç”³è¯·è¿½è¸ª</h1>
                <div class="card">
                    <div class="card-header"><h2 id="modification-page-title">æˆ‘æäº¤çš„ä¿®æ”¹ç”³è¯·</h2></div>
                    <table id="modification-table"><thead></thead><tbody></tbody></table>
                </div>
            </div>
            <div id="page-employee-requests-approval" class="page">
                <h1>å‘˜å·¥ç”³è¯·å®¡æ‰¹</h1>
                <div class="card">
                    <div class="card-header"><h2>å¾…æˆ‘å®¡æ‰¹çš„å‘˜å·¥ä¿®æ”¹ç”³è¯·</h2></div>
                    <table id="employee-approval-table"><thead></thead><tbody></tbody></table>
                </div>
            </div>
             <div id="page-calculation-results" class="page">
                 <div class="page-header-container">
                     <h1>æ ¸ç®—ç»“æœè¯¦æƒ…</h1>
                     <div id="results-powerbi-container"></div>
                 </div>
                 <p class="page-description">æ­¤é¡µé¢å±•ç¤ºæ¯ä¸ªä¸šåŠ¡æ¡ç›®åˆ†é…åˆ°å…·ä½“å‘˜å·¥åçš„è¯¦ç»†ææˆæ ¸ç®—ç»“æœï¼ŒåŒ…æ‹¬æ‰€æœ‰ä¸­é—´å‚æ•°ã€‚</p>
                 <div class="card">
                     <div class="card-header"><h2>ææˆæ ¸ç®—åˆ—è¡¨</h2></div>
                     <table id="calculation-results-table">
                         <thead></thead>
                         <tbody></tbody>
                     </table>
                 </div>
            </div>
            <div id="page-calculation-analysis" class="page">
                 <h1>æ ¸ç®—åˆ†ææŠ¥å‘Š (AIæ¨¡æ‹Ÿ)</h1>
                 <p class="page-description">ç³»ç»ŸåŸºäºå½“å‰åŠå†å²æ•°æ®ï¼Œè‡ªåŠ¨å¯¹ææˆæƒ…å†µè¿›è¡Œåˆ†æï¼Œå¹¶ç”Ÿæˆæ‘˜è¦æŠ¥å‘Šå’Œå¯è§†åŒ–å›¾è¡¨ã€‚</p>
                 <div class="analysis-grid">
                     <div class="card full-width">
                         <div class="card-header"><h2>æœˆåº¦ææˆåˆ†ææ‘˜è¦</h2></div>
                         <div id="analysis-report-section" class="report-section"></div>
                     </div>
                     <div class="card">
                         <div class="card-header"><h2>å…¬å¸æœˆåº¦ææˆæ€»é¢å¯¹æ¯”</h2></div>
                         <div class="chart-container">
                            <canvas id="company-trend-chart"></canvas>
                         </div>
                     </div>
                     <div class="card">
                         <div class="card-header"><h2>ä¸ªäººææˆç¯æ¯”å˜åŒ–</h2></div>
                         <div id="personal-trend-section" class="report-section"></div>
                     </div>
                 </div>
            </div>
            <div id="page-rules-engine" class="page">
                <h1>æ ¸ç®—è§„åˆ™è®¾ç½®</h1>
                <p class="page-description">åœ¨æ­¤å¤„ç®¡ç†ç”¨äºè‡ªåŠ¨è®¡ç®—ææˆé‡‘é¢çš„è¡¥å·®ç³»æ•°ã€‚æ‚¨å¯ä»¥åˆ›å»ºæ–°çš„ç³»æ•°å­—æ®µï¼Œå¹¶é€šè¿‡ç®€å•çš„é€»è¾‘è§„åˆ™å®šä¹‰å…¶å–å€¼æ–¹å¼ã€‚</p>
                <div class="page-actions">
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="openAddNewCoefficientModal()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></svg>
                            æ·»åŠ æ–°ç³»æ•°
                        </button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><h2>å·²å®šä¹‰ç³»æ•°åˆ—è¡¨</h2></div>
                    <table id="coefficients-table">
                        <thead>
                            <tr><th>ç³»æ•°åç§°</th><th>æ“ä½œ</th></tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="details-modal" class="modal"><div class="modal-content"><div class="modal-header"><h2 id="details-modal-title"></h2><span class="close-btn">&times;</span></div><div class="modal-body" id="details-modal-body"></div><div class="modal-footer" id="details-modal-footer"></div></div></div>
    <div id="allocation-modal" class="modal"><div class="modal-content"><div class="modal-header"><h2>ä¿®æ”¹åˆ†é…æ–¹æ¡ˆ</h2><span class="close-btn">&times;</span></div><div class="modal-body"><p><strong>åˆåŒå·:</strong> <span id="alloc-modal-contract-id"></span></p><div class="form-group"><label>åˆ†é…æ–¹æ¡ˆ</label><div id="modal-allocations"></div></div><div id="manage-participants"><label>ç®¡ç†å‚ä¸äººå‘˜</label><div class="allocation-row"><select id="employee-to-add"></select><button class="btn btn-sm btn-outline" onclick="addEmployeeToAllocation()">æ·»åŠ å‘˜å·¥</button><span class="total">å½“å‰æ€»è®¡: <span id="alloc-total">0</span>%</span></div></div></div><div class="modal-footer"><button class="btn btn-outline close-btn">å–æ¶ˆ</button><button id="save-allocation-btn" class="btn btn-primary">ä¿å­˜</button></div></div></div>
    <div id="add-missing-business-modal" class="modal"><div class="modal-content"><div class="modal-header"><h2>è¡¥å……é—æ¼ä¸šåŠ¡æ¡ç›®</h2><span class="close-btn">&times;</span></div><div class="modal-body"><p>è¯·å¡«å†™æ‚¨å‚ä¸è¿‡ä½†æœªåœ¨åˆ—è¡¨ä¸­æ˜¾ç¤ºçš„ä¸šåŠ¡ä¿¡æ¯ã€‚</p><div class="form-group"><label for="missing-contract-id">åˆåŒå· / ç”µæ¢¯å·¥å·</label><input type="text" id="missing-contract-id"></div><div class="form-group"><label for="missing-notes">å¤‡æ³¨è¯´æ˜</label><textarea id="missing-notes" rows="3"></textarea></div></div><div class="modal-footer"><button class="btn btn-outline close-btn">å–æ¶ˆ</button><button id="submit-missing-business-btn" class="btn btn-primary">æäº¤æ ¸å®</button></div></div></div>
    <div id="employee-modification-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>ç”³è¯·ä¿®æ”¹ææˆæ¯”ä¾‹</h2><span class="close-btn">&times;</span>
            </div>
            <div class="modal-body">
                <p><strong>åˆåŒå·:</strong> <span id="emp-mod-contract-id"></span></p>
                <div class="form-group">
                    <label for="emp-mod-new-ratio">æœŸæœ›æ¯”ä¾‹ (%)</label>
                    <input type="number" id="emp-mod-new-ratio" min="0" max="100">
                </div>
                <div class="form-group">
                    <label for="emp-mod-reason">ç”³è¯·ç†ç”±</label>
                    <textarea id="emp-mod-reason" rows="4"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline close-btn">å–æ¶ˆ</button>
                <button id="submit-employee-modification-btn" class="btn btn-primary">æäº¤ç”³è¯·</button>
            </div>
        </div>
    </div>
    <div id="modification-details-modal" class="modal"><div class="modal-content"><div class="modal-header"><h2 id="mod-details-title">å®¡æ‰¹ä¿®æ”¹ç”³è¯·</h2><span class="close-btn">&times;</span></div><div class="modal-body" id="mod-details-body"></div><div class="modal-footer" id="mod-details-footer"></div></div></div>
    <div id="logic-editor-modal" class="modal"><div class="modal-content" style="max-width: 1000px;"><div class="modal-header"><h2 id="logic-editor-title">ç¼–è¾‘é€»è¾‘</h2><span class="close-btn">&times;</span></div><div class="modal-body"><div class="logic-editor-container"><div class="logic-editor form-group"><label for="logic-textarea">è§„åˆ™å®šä¹‰</label><textarea id="logic-textarea"></textarea></div><div class="logic-help"><h5>è¯­æ³•å¸®åŠ©</h5><p>ä½¿ç”¨ `IF...THEN...` æ ¼å¼å®šä¹‰è§„åˆ™ï¼Œæ¯è¡Œä¸€æ¡ã€‚</p><ul><li>`IF [å­—æ®µ] [è¿ç®—ç¬¦] [å€¼] THEN [ç»“æœ]`</li><li>å¯ä½¿ç”¨ `DEFAULT [ç»“æœ]` å®šä¹‰é»˜è®¤å€¼ã€‚</li></ul><br><h5>å¯ç”¨å­—æ®µ</h5><p>`é¡¹ç›®åç§°`, `å®¢æˆ·`, `é‡‘é¢`, `åœ°ç›˜`</p><br><h5>å¯ç”¨è¿ç®—ç¬¦</h5><p>`=`, `CONTAINS`, `>`, `<`, `>=`</p></div></div></div><div class="modal-footer"><button class="btn btn-outline close-btn">å–æ¶ˆ</button><button id="save-logic-btn" class="btn btn-primary">ä¿å­˜é€»è¾‘</button></div></div></div>
    <div id="add-coefficient-modal" class="modal"><div class="modal-content" style="max-width: 500px;"><div class="modal-header"><h2>æ·»åŠ æ–°ç³»æ•°</h2><span class="close-btn">&times;</span></div><div class="modal-body"><div class="form-group"><label for="new-coefficient-name">ç³»æ•°åç§°</label><input type="text" id="new-coefficient-name" placeholder="ä¾‹å¦‚ï¼šåœ°ç›˜éš¾åº¦ç³»æ•°"></div></div><div class="modal-footer"><button class="btn btn-outline close-btn">å–æ¶ˆ</button><button id="add-coefficient-btn" class="btn btn-primary">ç¡®è®¤æ·»åŠ </button></div></div></div>

    <div id="powerbi-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>PowerBI å¯è§†åŒ–æ¨¡æ‹Ÿ</h2>
                <span class="close-btn">&times;</span>
            </div>
            <div class="modal-body">
                <div class="powerbi-view">
                    <div class="fields-panel" id="powerbi-fields-panel">
                        </div>
                    <div class="chart-panel">
                        <div class="chart-container" style="height: 45vh;">
                           <canvas id="powerbi-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
             <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeModal('powerbi-modal')">å…³é—­</button>
            </div>
        </div>
    </div>
    <script>
document.addEventListener('DOMContentLoaded', function() {
    
    // --- STATE MANAGEMENT ---
    let currentUserRole = 'employee'; 
    let activeUser = { id: 'E001', name: 'å¼ ä¸‰' };
    let activeCommissionType = 'maintenance_ops';
    let specialistActiveTab = 'unconfirmed';
    // --- æ–°å¢ä»£ç å¼€å§‹ ---
    let currentPowerBiChart = null; // ç”¨äºå­˜å‚¨PowerBIå›¾è¡¨å®ä¾‹
    // --- æ–°å¢ä»£ç ç»“æŸ ---


    // --- DATA ---
    const employees = [ { id: 'E001', name: 'å¼ ä¸‰' }, { id: 'E002', name: 'æå››' }, { id: 'E003', name: 'ç‹äº”' }, { id: 'E004', name: 'èµµå…­' }, { id: 'E005', name: 'å­™ä¸ƒ' }, { id: 'E006', name: 'å‘¨å…«' } ];
    let businessData = {
        maintenance_ops: [ // ä½œä¸šè®¡ææ•°æ®
            { id: 1, contractId: 'HT2025-07-001', project: 'å¤§å‹å•†åœºç”µæ¢¯ç»´ä¿', amount: 50000, client: 'ç¯çƒè´­ç‰©ä¸­å¿ƒ', status: 'abnormal', finalAllocation: [], maintenanceDate: '2025-07-20', contractEffectiveDate: '2025-07-01', site: 'å¸‚ä¸­å¿ƒAåŒº' },
            { id: 2, contractId: 'HT2025-07-002', project: 'åŒ»é™¢ç´§æ€¥ç»´ä¿®', amount: 15000, client: 'å¸‚ç¬¬ä¸€äººæ°‘åŒ»é™¢', status: 'unconfirmed', finalAllocation: [{ employee: 'å‘¨å…«', ratio: 100 }], maintenanceDate: '2025-07-22', contractEffectiveDate: '2025-07-05', site: 'æ—¥ç«‹ç”µæ¢¯' },
            { id: 3, contractId: 'HT2025-06-113', project: 'Aæ ‹å†™å­—æ¥¼å­£åº¦ä¿å…»', amount: 30000, client: 'ä¸‡ç§‘åœ°äº§', status: 'modification_pending', finalAllocation: [{ employee: 'å¼ ä¸‰', ratio: 80 }, { employee: 'æå››', ratio: 20 }], maintenanceDate: '2025-06-25', contractEffectiveDate: '2025-06-01', site: 'é‡‘èè¡—' },
        ],
        maintenance_biz: [ // ä¸šåŠ¡è®¡ææ•°æ®
             { id: 4, contractId: 'HT2025-06-105', project: 'Båº§å…¬å¯“ç”µæ¢¯æ›´æ¢åˆåŒ', amount: 180000, client: 'ç»¿åœ°é›†å›¢', status: 'confirmed', finalAllocation: [{ employee: 'å¼ ä¸‰', ratio: 50 }, { employee: 'ç‹äº”', ratio: 50 }], maintenanceDate: '2025-06-15', contractEffectiveDate: '2025-05-10', site: 'è¿‘éƒŠåˆ«å¢…åŒº' },
             { id: 5, contractId: 'HT2025-06-108', project: 'Cæ ‹ç”µæ¢¯å¤§ä¿®åˆåŒ', amount: 95000, client: 'åæ¶¦ç½®åœ°', status: 'modification_pending', finalAllocation: [{ employee: 'æå››', ratio: 100 }], maintenanceDate: '2025-06-18', contractEffectiveDate: '2025-05-15', site: 'è€åŸåŒº' },
        ]
    };
    
    let modificationRequests = [
        { id: 'MOD-001', businessId: 5, contractId: 'HT2025-06-108', timestamp: '2025-07-15', approvalStatus: 'pending', type: 'specialist_rewrite', submitter: {name: 'æ ¸ç®—ä¸“å‘˜'}, details: { old: [{ employee: 'æå››', ratio: 100 }], new: [{ employee: 'æå››', ratio: 70 }, { employee: 'èµµå…­', ratio: 30 }] }},
        { id: 'MOD-002', businessId: 3, contractId: 'HT2025-06-113', timestamp: '2025-07-16', approvalStatus: 'pending', type: 'employee_suggestion', submitter: {name: 'å¼ ä¸‰'}, details: { from: 80, to: 85 } },
        { id: 'MOD-003', businessId: 4, contractId: 'HT2025-06-105', timestamp: '2025-07-14', approvalStatus: 'approved', type: 'employee_suggestion', submitter: {name: 'ç‹äº”'}, details: { from: 50, to: 60 } },
        { id: 'MOD-004', businessId: 2, contractId: 'HT2025-07-002', timestamp: '2025-07-17', approvalStatus: 'pending', type: 'employee_join_request', submitter: {name: 'æå››'}, details: { old: [{ employee: 'å‘¨å…«', ratio: 100 }], new: [{ employee: 'å‘¨å…«', ratio: 50 }, { employee: 'æå››', ratio: 50 }] } },
    ];
    
    let coefficients = [
        { id: 1, name: 'åœ°ç›˜é©»åœºè¡¥å·®', logic: 'IF åœ°ç›˜ CONTAINS "æ—¥ç«‹ç”µæ¢¯" THEN 2.5\nIF åœ°ç›˜ = "å¸‚ä¸­å¿ƒAåŒº" THEN 1.8\nDEFAULT 1.0' },
        { id: 2, name: 'åè¿œåœ°åŒºè¡¥å·®', logic: 'IF åœ°å€ CONTAINS "æ¸…è¿œ" THEN 1.5\nDEFAULT 1.0' }
    ];

    // --- UTILITY FUNCTIONS ---
    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) modal.style.display = 'none';
    }

    // --- RENDER FUNCTIONS ---
    const getStatusBadge = (status) => {
        const statuses = { 'unconfirmed': '<span class="status status-unconfirmed">æœªç¡®è®¤</span>', 'confirmed': '<span class="status status-confirmed">å·²ç¡®è®¤</span>', 'abnormal': '<span class="status status-abnormal">å¼‚å¸¸</span>', 'modification_pending': '<span class="status status-modification">ä¿®æ”¹å¾…å®¡æ‰¹</span>' };
        return statuses[status] || status;
    };
    const formatAllocation = (allocation) => (!allocation || allocation.length === 0) ? 'æœªåˆ†é…' : allocation.map(a => `${a.employee}: ${a.ratio}%`).join('; ');
    
    window.switchSpecialistTab = function(tabName) {
        specialistActiveTab = tabName;
        renderAllocationTable();
    };

    function renderAllocationTable() {
        const actionsDiv = document.getElementById('allocation-page-actions');
        const tabsContainer = document.getElementById('allocation-tabs-container');
        const tableTitle = document.getElementById('allocation-table-title');
        const thead = document.getElementById('allocation-table').querySelector('thead');
        const tbody = document.getElementById('allocation-table').querySelector('tbody');
        let headers = [];
        tbody.innerHTML = ''; thead.innerHTML = ''; actionsDiv.innerHTML = ''; tabsContainer.innerHTML = '';
        // --- æ–°å¢ä»£ç å¼€å§‹ ---
        const powerBiContainer = document.getElementById('allocation-powerbi-container');
        powerBiContainer.innerHTML = '';
        // --- æ–°å¢ä»£ç ç»“æŸ ---

        let dataToRender = businessData[activeCommissionType] || [];

        if (currentUserRole === 'employee') {
            tableTitle.textContent = "æˆ‘çš„ä¸šåŠ¡åˆ—è¡¨";
            actionsDiv.innerHTML = `<div class="action-buttons"><button class="btn btn-primary" onclick="openAddMissingBusinessModal()"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></svg>è¡¥å……é—æ¼ä¸šåŠ¡</button></div>`;
            headers = ['åˆåŒå·/å·¥å·', 'é¡¹ç›®åç§°', 'æˆ‘çš„ææˆæ¯”ä¾‹', 'åˆ†é…æ–¹æ¡ˆ', 'çŠ¶æ€', 'æ“ä½œ'];
            thead.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
            dataToRender = dataToRender.filter(item => item.finalAllocation.some(a => a.employee === activeUser.name));
        } else { // Specialist View
            // --- æ–°å¢ä»£ç å¼€å§‹ ---
            powerBiContainer.innerHTML = `<button class="btn btn-outline" onclick="openPowerBIModal('allocation')"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M4 18h16v-2H4v2zm0-5h16v-2H4v2zm0-5h16V6H4v2z"></path></svg>PowerBIå¯è§†åŒ–</button>`;
            // --- æ–°å¢ä»£ç ç»“æŸ ---
            tabsContainer.innerHTML = `<div class="tabs"><span class="tab-link ${specialistActiveTab === 'unconfirmed' ? 'active' : ''}" onclick="switchSpecialistTab('unconfirmed')">æœªç¡®è®¤</span><span class="tab-link ${specialistActiveTab === 'confirmed' ? 'active' : ''}" onclick="switchSpecialistTab('confirmed')">å·²ç¡®è®¤</span></div>`;

            if (specialistActiveTab === 'unconfirmed') {
                tableTitle.textContent = "å¾…å¤„ç†ä¸šåŠ¡åˆ—è¡¨";
                actionsDiv.innerHTML = `
                    <div class="filters">
                        <div class="filter-group"><label for="filter-maintenance-date">ä¿å…»ä½œä¸šæ—¶é—´:</label><input type="date" id="filter-maintenance-date"></div>
                        <div class="filter-group"><label for="filter-effective-date">åˆåŒç”Ÿæ•ˆæ—¶é—´:</label><input type="date" id="filter-effective-date"></div>
                        <div class="filter-group"><label for="filter-status">çŠ¶æ€:</label>
                          <select id="filter-status">
                            <option value="">å…¨éƒ¨ (æœªç¡®è®¤)</option><option value="unconfirmed">æœªç¡®è®¤</option><option value="abnormal">å¼‚å¸¸</option><option value="modification_pending">ä¿®æ”¹å¾…å®¡æ‰¹</option>
                          </select>
                        </div>
                        <button class="btn btn-outline btn-sm" onclick="renderAllocationTable()">ç­›é€‰</button>
                        <button class="btn btn-outline btn-sm" onclick="clearFilters()">æ¸…ç©ºç­›é€‰</button>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="batchConfirmItems()">æ‰¹é‡ç¡®è®¤</button>
                        <button class="btn btn-secondary" onclick="exportData()">å¯¼å‡º</button>
                        <button class="btn btn-secondary" onclick="alert('å¯¼å…¥åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ã€‚')">å¯¼å…¥</button>
                    </div>`;
                headers = ['', 'åˆåŒå·/å·¥å·', 'é¡¹ç›®åç§°', ...coefficients.map(c => c.name), 'åˆ†é…æ–¹æ¡ˆ', 'çŠ¶æ€'];
                thead.innerHTML = `<tr><th><input type="checkbox" onchange="toggleAllCheckboxes(this.checked)"></th>${headers.slice(1).map(h => `<th>${h}</th>`).join('')}</tr>`;
                
                const statusFilter = document.getElementById('filter-status')?.value;
                const maintenanceDateFilter = document.getElementById('filter-maintenance-date')?.value;
                const effectiveDateFilter = document.getElementById('filter-effective-date')?.value;
                dataToRender = dataToRender.filter(item => {
                    const isUnconfirmedGroup = ['unconfirmed', 'abnormal', 'modification_pending'].includes(item.status);
                    if (!isUnconfirmedGroup) return false;
                    const statusMatch = !statusFilter || item.status === statusFilter;
                    const maintenanceMatch = !maintenanceDateFilter || item.maintenanceDate === maintenanceDateFilter;
                    const effectiveMatch = !effectiveDateFilter || item.contractEffectiveDate === effectiveDateFilter;
                    return statusMatch && maintenanceMatch && effectiveMatch;
                });
            } else { // Confirmed Tab
                tableTitle.textContent = "å·²ç¡®è®¤ä¸šåŠ¡åˆ—è¡¨";
                 actionsDiv.innerHTML = `
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="exportData()">å¯¼å‡º</button>
                    </div>`;
                headers = ['åˆåŒå·/å·¥å·', 'é¡¹ç›®åç§°', ...coefficients.map(c => c.name), 'åˆ†é…æ–¹æ¡ˆ', 'çŠ¶æ€'];
                thead.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
                dataToRender = dataToRender.filter(item => item.status === 'confirmed');
            }
        }

        if (dataToRender.length === 0) {
            tbody.innerHTML = `<tr><td colspan="${headers.length}" style="text-align:center; padding: 40px;">æš‚æ— æ•°æ®ã€‚</td></tr>`;
            return;
        }

        dataToRender.forEach(item => {
            const tr = document.createElement('tr');
            const coefficientTds = coefficients.map(c => `<td data-label="${c.name}">${calculateCoefficient(c, item)}</td>`).join('');
            
            if (currentUserRole === 'specialist') {
                tr.style.cursor = 'pointer';
                tr.onclick = (e) => {
                    if (e.target.type === 'checkbox' || e.target.closest('button')) return;
                    openDetailsModal(item.id);
                };
                if (specialistActiveTab === 'unconfirmed') {
                    tr.innerHTML = `<td data-label="${headers[0]}"><input type="checkbox" class="item-checkbox" data-id="${item.id}" onclick="event.stopPropagation();"></td><td data-label="åˆåŒå·/å·¥å·">${item.contractId}</td><td data-label="é¡¹ç›®åç§°">${item.project}</td>${coefficientTds}<td data-label="åˆ†é…æ–¹æ¡ˆ">${formatAllocation(item.finalAllocation)}</td><td data-label="çŠ¶æ€">${getStatusBadge(item.status)}</td>`;
                } else {
                     tr.innerHTML = `<td data-label="åˆåŒå·/å·¥å·">${item.contractId}</td><td data-label="é¡¹ç›®åç§°">${item.project}</td>${coefficientTds}<td data-label="åˆ†é…æ–¹æ¡ˆ">${formatAllocation(item.finalAllocation)}</td><td data-label="çŠ¶æ€">${getStatusBadge(item.status)}</td>`;
                }
            } else {
                tr.classList.add('no-hover');
                const myAlloc = item.finalAllocation.find(a => a.employee === activeUser.name);
                tr.innerHTML = `<td data-label="åˆåŒå·/å·¥å·">${item.contractId}</td><td data-label="é¡¹ç›®åç§°">${item.project}</td><td data-label="æˆ‘çš„ææˆæ¯”ä¾‹">${myAlloc ? myAlloc.ratio + '%' : 'N/A'}</td><td data-label="åˆ†é…æ–¹æ¡ˆ">${formatAllocation(item.finalAllocation)}</td><td data-label="çŠ¶æ€">${getStatusBadge(item.status)}</td><td data-label="æ“ä½œ"><button class="btn btn-sm btn-outline" onclick="openDetailsModal(${item.id})">è¯¦æƒ…</button> <button class="btn btn-sm btn-primary" onclick="openModificationModalForEmployee(${item.id})">ç”³è¯·ä¿®æ”¹</button></td>`;
            }
            tbody.appendChild(tr);
        });
    }

    function renderModificationProcessingTable() {
        const title = document.getElementById('modification-page-title');
        const tbody = document.getElementById('modification-table').querySelector('tbody');
        const headers = ['ç”³è¯·ID', 'ç›¸å…³åˆåŒå·', 'ç”³è¯·ç±»å‹', 'ç”³è¯·æ—¥æœŸ', 'å®¡æ‰¹çŠ¶æ€', 'æ“ä½œ'];
        document.getElementById('modification-table').querySelector('thead').innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
        tbody.innerHTML = '';
        let dataToRender = (currentUserRole === 'specialist') ? modificationRequests : modificationRequests.filter(req => req.submitter.name === activeUser.name);
        title.textContent = (currentUserRole === 'specialist') ? 'å…¨éƒ¨ä¿®æ”¹ç”³è¯·è¿½è¸ª' : `æˆ‘ (${activeUser.name}) æäº¤çš„ä¿®æ”¹ç”³è¯·`;

        if (dataToRender.length === 0) {
            tbody.innerHTML = '<tr class="no-hover"><td colspan="6" style="text-align:center; padding: 40px;">æš‚æ— ç›¸å…³è®°å½•ã€‚</td></tr>'; return;
        }

        dataToRender.forEach(req => {
            const approvalStatusBadges = { pending: '<span class="status status-unconfirmed">å¾…å®¡æ‰¹</span>', approved: '<span class="status status-confirmed">å·²æ‰¹å‡†</span>', rejected: '<span class="status status-abnormal">å·²é©³å›</span>' };
            const requestTypes = { 'employee_suggestion': `å‘˜å·¥æ¯”ä¾‹å»ºè®®`, 'specialist_rewrite': 'ä¸“å‘˜é‡åˆ†é…', 'employee_join_request': `å‘˜å·¥åŠ å…¥ç”³è¯·`, 'business_info_update': 'æ ¸å¿ƒä¸šåŠ¡ä¿¡æ¯ä¿®æ­£'};
            const requestTypeDesc = `${requestTypes[req.type]} (${req.submitter.name})`;
            const pushButton = (req.approvalStatus !== 'pending') ? `<button class="btn btn-sm btn-outline" onclick="event.stopPropagation(); alert('å·²å‘ç›¸å…³äººå‘˜æ¨é€å…³äº ${req.id} çš„ç»“æœé€šçŸ¥ã€‚')">æ¨é€é€šçŸ¥</button>` : 'â€”';

            const mainRow = document.createElement('tr');
            mainRow.className = 'main-row no-hover'; mainRow.style.cursor = 'pointer';
            mainRow.onclick = (e) => { if(e.target.closest('button')) return; toggleSubRow(req.id, mainRow); };
            mainRow.innerHTML = `<td data-label="${headers[0]}"><span style="color: var(--text-primary);">${req.id}</span><span class="arrow-icon">â–¶</span></td><td data-label="${headers[1]}">${req.contractId}</td><td data-label="${headers[2]}">${requestTypeDesc}</td><td data-label="${headers[3]}">${req.timestamp}</td><td data-label="${headers[4]}">${approvalStatusBadges[req.approvalStatus]}</td><td data-label="${headers[5]}">${pushButton}</td>`;
            tbody.appendChild(mainRow);
            
            const subRow = document.createElement('tr');
            subRow.className = 'sub-row'; subRow.id = `sub-row-${req.id}`;
            subRow.innerHTML = `<td colspan="6">${buildSubRowContent(req)}</td>`;
            tbody.appendChild(subRow);
        });
    }

    function buildSubRowContent(req) {
        let allBusinessData = [...businessData.maintenance_ops, ...businessData.maintenance_biz];
        const businessItem = allBusinessData.find(b => b.id === req.businessId);
        let content = `<div class="sub-row-content"><div><h5>å…³è”ä¸šåŠ¡åŸºç¡€ä¿¡æ¯</h5>${businessItem ? `<p><strong>é¡¹ç›®:</strong> ${businessItem.project}</p><p><strong>å®¢æˆ·:</strong> ${businessItem.client}</p><p><strong>é‡‘é¢:</strong> ${businessItem.amount.toLocaleString()}</p>` : '<p>æœªæ‰¾åˆ°å…³è”ä¸šåŠ¡ã€‚</p>'}</div>`;
        let changeDetailsHtml = '<div><h5>å˜æ›´å†…å®¹è¯¦æƒ…</h5>';
        switch (req.type) {
            case 'employee_suggestion': changeDetailsHtml += `<div class="change-item"><strong>${req.submitter.name} æ¯”ä¾‹: </strong> <span class="change-old">${req.details.from}%</span> â†’ <span class="change-new">${req.details.to}%</span></div>`; break;
            case 'business_info_update': changeDetailsHtml += Object.keys(req.details.new).map(key => (req.details.old[key] !== req.details.new[key]) ? `<div class="change-item"><strong>${{amount: 'é‡‘é¢', client: 'å®¢æˆ·'}[key] || key}: </strong> <span class="change-old">${req.details.old[key]}</span> â†’ <span class="change-new">${req.details.new[key]}</span></div>` : '').join(''); break;
            case 'specialist_rewrite': case 'employee_join_request':
                const oldAllocMap = new Map((req.details.old || []).map(item => [item.employee, item.ratio]));
                const newAllocMap = new Map((req.details.new || []).map(item => [item.employee, item.ratio]));
                const allNames = new Set([...oldAllocMap.keys(), ...newAllocMap.keys()]);
                changeDetailsHtml += '<div><h5>å˜æ›´å‰</h5>';
                (req.details.old || []).forEach(a => { changeDetailsHtml += `<p>${a.employee}: ${a.ratio}%</p>`});
                if ((req.details.old || []).length === 0) changeDetailsHtml += '<p>æ— </p>';
                changeDetailsHtml += '</div><div><h5>å˜æ›´å</h5>';
                allNames.forEach(name => {
                    const oldRatio = oldAllocMap.get(name); const newRatio = newAllocMap.get(name);
                    if (oldRatio === undefined && newRatio !== undefined) { changeDetailsHtml += `<p class="change-new">+ ${name}: ${newRatio}%</p>`; }
                    else if (oldRatio !== undefined && newRatio === undefined) { changeDetailsHtml += `<p class="change-old">- ${name}: ${oldRatio}%</p>`; }
                    else if (oldRatio !== newRatio) { changeDetailsHtml += `<p>  ${name}: <span class="change-old">${oldRatio}%</span> â†’ <span class="change-new">${newRatio}%</span></p>`; }
                });
                changeDetailsHtml += '</div>'; break;
        }
        changeDetailsHtml += '</div>'; content += changeDetailsHtml + '</div>';
        return content;
    }

    window.toggleSubRow = function(reqId, clickedRow) {
        const subRow = document.getElementById(`sub-row-${reqId}`); if (!subRow) return;
        const isCurrentlyVisible = subRow.classList.contains('visible');
        document.querySelectorAll('.sub-row.visible').forEach(openSubRow => { openSubRow.classList.remove('visible'); openSubRow.previousElementSibling.classList.remove('parent-row-active'); });
        if (!isCurrentlyVisible) { subRow.classList.add('visible'); clickedRow.classList.add('parent-row-active'); }
    }
    
    function renderEmployeeRequestsApprovalTable() {
        const tbody = document.getElementById('employee-approval-table').querySelector('tbody');
        const thead = document.getElementById('employee-approval-table').querySelector('thead');
        const headers = ['ç”³è¯·ID', 'ç›¸å…³åˆåŒå·', 'ç”³è¯·äºº', 'ç”³è¯·ç±»å‹', 'ç”³è¯·æ—¥æœŸ', 'æ“ä½œ'];
        thead.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
        tbody.innerHTML = '';
        
        const pendingRequests = modificationRequests.filter(req => req.approvalStatus === 'pending' && req.submitter.name !== 'æ ¸ç®—ä¸“å‘˜');
        
        if (pendingRequests.length === 0) {
            tbody.innerHTML = '<tr class="no-hover"><td colspan="6" style="text-align:center; padding: 40px;">æ²¡æœ‰å¾…å®¡æ‰¹çš„å‘˜å·¥ç”³è¯·ã€‚</td></tr>';
            return;
        }
        
        pendingRequests.forEach(req => {
            const requestTypes = { 'employee_suggestion': 'æ¯”ä¾‹è°ƒæ•´å»ºè®®', 'employee_join_request': 'åŠ å…¥ä¸šåŠ¡ç”³è¯·' };
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td data-label="${headers[0]}">${req.id}</td>
                <td data-label="${headers[1]}">${req.contractId}</td>
                <td data-label="${headers[2]}">${req.submitter.name}</td>
                <td data-label="${headers[3]}">${requestTypes[req.type] || 'æœªçŸ¥ç±»å‹'}</td>
                <td data-label="${headers[4]}">${req.timestamp}</td>
                <td data-label="${headers[5]}"><button class="btn btn-sm btn-primary" onclick="openModificationDetailsModal('${req.id}')">å¤„ç†</button></td>
            `;
            tbody.appendChild(tr);
        });
    }
    
    function renderRulesEnginePage() {
        const tbody = document.getElementById('coefficients-table').querySelector('tbody');
        tbody.innerHTML = '';
        if (coefficients.length === 0) {
            tbody.innerHTML = '<tr><td colspan="2" style="text-align: center;">æš‚æ— è‡ªå®šä¹‰ç³»æ•°ï¼Œè¯·æ·»åŠ ã€‚</td></tr>';
            return;
        }
        coefficients.forEach(c => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td data-label="ç³»æ•°åç§°">${c.name}</td><td data-label="æ“ä½œ"><button class="btn btn-sm btn-outline" onclick="openLogicEditorModal(${c.id})">ç¼–è¾‘é€»è¾‘</button> <button class="btn btn-sm btn-secondary" onclick="deleteCoefficient(${c.id})">åˆ é™¤</button></td>`;
            tbody.appendChild(tr);
        });
    }

    // --- æ–°å¢ä»£ç å¼€å§‹ ---

    function getCommissionResults() {
        const allBusiness = [...businessData.maintenance_ops, ...businessData.maintenance_biz];
        const results = [];
        allBusiness.forEach(item => {
            if (item.finalAllocation && item.finalAllocation.length > 0) {
                item.finalAllocation.forEach(alloc => {
                    let totalCoefficient = 1;
                    const appliedCoefficients = {};
                    coefficients.forEach(c => {
                        const value = calculateCoefficient(c, item);
                        totalCoefficient *= value;
                        appliedCoefficients[c.name] = value;
                    });
                    const commissionAmount = item.amount * (alloc.ratio / 100) * totalCoefficient;
                    results.push({
                        ...item, // åŸºç¡€ä¸šåŠ¡ä¿¡æ¯
                        employee: alloc.employee,
                        ratio: alloc.ratio,
                        appliedCoefficients: appliedCoefficients,
                        totalCoefficient: totalCoefficient,
                        commissionAmount: commissionAmount
                    });
                });
            }
        });
        return results;
    }

    function renderCalculationResultsPage() {
        if(currentUserRole !== 'specialist') return;

        const powerBiContainer = document.getElementById('results-powerbi-container');
        powerBiContainer.innerHTML = `<button class="btn btn-outline" onclick="openPowerBIModal('results')"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M4 18h16v-2H4v2zm0-5h16v-2H4v2zm0-5h16V6H4v2z"></path></svg>PowerBIå¯è§†åŒ–</button>`;

        const table = document.getElementById('calculation-results-table');
        const thead = table.querySelector('thead');
        const tbody = table.querySelector('tbody');

        const headers = ['åˆåŒå·', 'é¡¹ç›®', 'å‘˜å·¥', 'åŸºç¡€é‡‘é¢', 'ææˆæ¯”ä¾‹', ...coefficients.map(c => c.name), 'ææˆé‡‘é¢'];
        thead.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
        tbody.innerHTML = '';

        const results = getCommissionResults();
        
        if (results.length === 0) {
            tbody.innerHTML = `<tr><td colspan="${headers.length}" style="text-align:center; padding: 40px;">æš‚æ— å·²åˆ†é…çš„æ ¸ç®—ç»“æœã€‚</td></tr>`;
            return;
        }

        results.forEach(res => {
            const tr = document.createElement('tr');
            const coefficientTds = coefficients.map(c => `<td data-label="${c.name}">${res.appliedCoefficients[c.name]}</td>`).join('');
            tr.innerHTML = `
                <td data-label="åˆåŒå·">${res.contractId}</td>
                <td data-label="é¡¹ç›®">${res.project}</td>
                <td data-label="å‘˜å·¥">${res.employee}</td>
                <td data-label="åŸºç¡€é‡‘é¢">${res.amount.toLocaleString()}</td>
                <td data-label="ææˆæ¯”ä¾‹">${res.ratio}%</td>
                ${coefficientTds}
                <td data-label="ææˆé‡‘é¢" style="font-weight:bold; color: var(--change-new-text);">${res.commissionAmount.toLocaleString('en-US', { style: 'currency', currency: 'CNY' })}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function renderCalculationAnalysisPage() {
        if(currentUserRole !== 'specialist') return;
        
        // æ¨¡æ‹Ÿä¸Šæœˆæ•°æ®
        const previousMonthResults = {
            totalCommission: 38500,
            byEmployee: { 'å¼ ä¸‰': 18000, 'æå››': 9500, 'ç‹äº”': 11000, 'èµµå…­': 0, 'å‘¨å…«': 0 }
        };

        const currentResults = getCommissionResults();
        const currentTotals = {
            totalCommission: 0,
            byEmployee: {}
        };
        
        employees.forEach(e => currentTotals.byEmployee[e.name] = 0);

        currentResults.forEach(res => {
            currentTotals.totalCommission += res.commissionAmount;
            if(currentTotals.byEmployee[res.employee] !== undefined) {
                currentTotals.byEmployee[res.employee] += res.commissionAmount;
            }
        });

        // ç”ŸæˆæŠ¥å‘Šæ–‡æœ¬
        const reportContainer = document.getElementById('analysis-report-section');
        const totalChange = currentTotals.totalCommission - previousMonthResults.totalCommission;
        const totalChangePercent = (previousMonthResults.totalCommission === 0) ? 100 : (totalChange / previousMonthResults.totalCommission * 100).toFixed(1);
        const changeClass = totalChange >= 0 ? 'positive' : 'negative';
        const changeIcon = totalChange >= 0 ? 'â–²' : 'â–¼';

        reportContainer.innerHTML = `
            <h3>æ•´ä½“åˆ†æ</h3>
            <p>æœ¬æœˆå…¬å¸ææˆæ€»é¢ä¸º <strong>${currentTotals.totalCommission.toLocaleString('en-US', { style: 'currency', currency: 'CNY' })}</strong>ï¼Œ
            ç›¸è¾ƒäºä¸Šæœˆçš„ ${previousMonthResults.totalCommission.toLocaleString('en-US', { style: 'currency', currency: 'CNY' })}ï¼Œ
            å˜åŒ–äº† <strong class="${changeClass}">${totalChange.toLocaleString('en-US', { style: 'currency', currency: 'CNY' })} (${changeIcon} ${Math.abs(totalChangePercent)}%)</strong>ã€‚</p>
        `;
        
        // æ¸²æŸ“ä¸ªäººåˆ†æ
        const personalContainer = document.getElementById('personal-trend-section');
        let personalHtml = '';
        Object.keys(currentTotals.byEmployee).forEach(name => {
             const current = currentTotals.byEmployee[name];
             const previous = previousMonthResults.byEmployee[name] || 0;
             if(current === 0 && previous === 0) return;

             const personalChange = current - previous;
             const personalChangePercent = (previous === 0) ? (current > 0 ? 100 : 0) : (personalChange / previous * 100).toFixed(1);
             const pChangeClass = personalChange >= 0 ? 'positive' : 'negative';
             const pChangeIcon = personalChange >= 0 ? 'â–²' : 'â–¼';

             personalHtml += `<p><strong>${name}:</strong> æœ¬æœˆ ${current.toLocaleString('en-US', { style: 'currency', currency: 'CNY' })}. ç¯æ¯” <span class="${pChangeClass}">${pChangeIcon} ${Math.abs(personalChangePercent)}%</span>.</p>`;
        });
        personalContainer.innerHTML = personalHtml;

        // ç»˜åˆ¶å›¾è¡¨
        const ctx = document.getElementById('company-trend-chart').getContext('2d');
        if (window.companyTrendChart instanceof Chart) {
             window.companyTrendChart.destroy();
        }
        window.companyTrendChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['ä¸Šæœˆæ€»é¢', 'æœ¬æœˆæ€»é¢'],
                datasets: [{
                    label: 'ææˆæ€»é¢ (CNY)',
                    data: [previousMonthResults.totalCommission, currentTotals.totalCommission],
                    backgroundColor: [ 'rgba(255, 99, 132, 0.2)', 'rgba(54, 162, 235, 0.2)' ],
                    borderColor: [ 'rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)' ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }

    window.openPowerBIModal = function(dataSourceKey) {
        let data, availableFields;
        if (dataSourceKey === 'allocation') {
            data = specialistActiveTab === 'unconfirmed' 
                ? businessData[activeCommissionType].filter(item => ['unconfirmed', 'abnormal', 'modification_pending'].includes(item.status))
                : businessData[activeCommissionType].filter(item => item.status === 'confirmed');
            availableFields = {
                dimensions: ['client', 'site', 'status'],
                measures: ['amount']
            };
        } else if (dataSourceKey === 'results') {
            data = getCommissionResults();
            availableFields = {
                dimensions: ['client', 'site', 'employee'],
                measures: ['amount', 'commissionAmount']
            };
        } else {
            return;
        }

        const modal = document.getElementById('powerbi-modal');
        const fieldsPanel = document.getElementById('powerbi-fields-panel');
        fieldsPanel.innerHTML = ''; // æ¸…ç©º

        // ç”Ÿæˆå­—æ®µé€‰æ‹©å™¨
        fieldsPanel.innerHTML += '<h4>ç»´åº¦ (Xè½´)</h4>';
        availableFields.dimensions.forEach(field => {
            fieldsPanel.innerHTML += `<div class="field-group"><label><input type="radio" name="dimension" value="${field}" onchange="updatePowerBIChart('${dataSourceKey}')"> ${field}</label></div>`;
        });
        fieldsPanel.innerHTML += '<h4 style="margin-top:20px;">åº¦é‡ (Yè½´)</h4>';
        availableFields.measures.forEach(field => {
            fieldsPanel.innerHTML += `<div class="field-group"><label><input type="radio" name="measure" value="${field}" onchange="updatePowerBIChart('${dataSourceKey}')"> ${field}</label></div>`;
        });
        
        modal.style.display = 'block';
        
        // é»˜è®¤é€‰ä¸­å¹¶æ¸²æŸ“ç¬¬ä¸€ä¸ªå›¾è¡¨
        fieldsPanel.querySelector('input[name="dimension"]').checked = true;
        fieldsPanel.querySelector('input[name="measure"]').checked = true;
        updatePowerBIChart(dataSourceKey);
    }
    
    window.updatePowerBIChart = function(dataSourceKey) {
        let rawData;
        if (dataSourceKey === 'allocation') {
            rawData = specialistActiveTab === 'unconfirmed' 
                ? businessData[activeCommissionType].filter(item => ['unconfirmed', 'abnormal', 'modification_pending'].includes(item.status))
                : businessData[activeCommissionType].filter(item => item.status === 'confirmed');
        } else if (dataSourceKey === 'results') {
            rawData = getCommissionResults();
        } else { return; }

        const dimension = document.querySelector('input[name="dimension"]:checked').value;
        const measure = document.querySelector('input[name="measure"]:checked').value;

        const aggregatedData = rawData.reduce((acc, item) => {
            const key = item[dimension] || 'N/A';
            if (!acc[key]) {
                acc[key] = 0;
            }
            acc[key] += item[measure] || 0;
            return acc;
        }, {});

        const labels = Object.keys(aggregatedData);
        const data = Object.values(aggregatedData);

        const ctx = document.getElementById('powerbi-chart').getContext('2d');
        if (currentPowerBiChart) {
            currentPowerBiChart.destroy();
        }
        currentPowerBiChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: `${measure} by ${dimension}`,
                    data: data,
                    backgroundColor: 'rgba(0, 123, 255, 0.2)',
                    borderColor: 'rgba(0, 123, 255, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                scales: {
                    x: { beginAtZero: true }
                }
            }
        });
    }


    // --- æ–°å¢ä»£ç ç»“æŸ ---

    window.openAddNewCoefficientModal = function() {
        document.getElementById('new-coefficient-name').value = '';
        document.getElementById('add-coefficient-modal').style.display = 'block';
    }

    document.getElementById('add-coefficient-btn').onclick = function() {
        const name = document.getElementById('new-coefficient-name').value.trim();
        if (name) {
            coefficients.push({ id: Date.now(), name, logic: 'DEFAULT 1.0' });
            renderRulesEnginePage();
            closeModal('add-coefficient-modal');
        } else {
            alert('è¯·è¾“å…¥ç³»æ•°åç§°ã€‚');
        }
    }
    
    window.deleteCoefficient = function(id) {
        if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤ç³»æ•°å—ï¼Ÿ')) {
            coefficients = coefficients.filter(c => c.id !== id);
            renderRulesEnginePage();
        }
    }

    window.openLogicEditorModal = function(id) {
        const coefficient = coefficients.find(c => c.id === id);
        if (coefficient) {
            document.getElementById('logic-editor-title').textContent = `ç¼–è¾‘é€»è¾‘: ${coefficient.name}`;
            document.getElementById('logic-textarea').value = coefficient.logic;
            document.getElementById('save-logic-btn').onclick = () => saveLogic(id);
            document.getElementById('logic-editor-modal').style.display = 'block';
        }
    }

    function saveLogic(id) {
        const coefficient = coefficients.find(c => c.id === id);
        coefficient.logic = document.getElementById('logic-textarea').value;
        alert('é€»è¾‘å·²ä¿å­˜ï¼');
        closeModal('logic-editor-modal');
    }

    function calculateCoefficient(coefficient, item) {
        const rules = coefficient.logic.split('\n').filter(line => line.trim() !== '');
        let defaultValue = 1.0;
        
        for (const rule of rules) {
            const defaultMatch = rule.match(/^DEFAULT\s+([0-9.]+)/i);
            if (defaultMatch) {
                defaultValue = parseFloat(defaultMatch[1]);
                continue;
            }
            const ifMatch = rule.match(/^IF\s+([^\s]+)\s+(CONTAINS|=|>|<|>=)\s+"?([^"]+)"?\s+THEN\s+([0-9.]+)/i);
            if (ifMatch) {
                const [, field, operator, value, result] = ifMatch;
                const itemValue = item[{'é¡¹ç›®åç§°':'project', 'å®¢æˆ·':'client', 'é‡‘é¢':'amount', 'åœ°ç›˜':'site'}[field]];
                
                let conditionMet = false;
                switch (operator.toUpperCase()) {
                    case '=': conditionMet = String(itemValue) === value; break;
                    case 'CONTAINS': conditionMet = String(itemValue).includes(value); break;
                    case '>': conditionMet = Number(itemValue) > Number(value); break;
                    case '<': conditionMet = Number(itemValue) < Number(value); break;
                    case '>=': conditionMet = Number(itemValue) >= Number(value); break;
                }
                if (conditionMet) return parseFloat(result);
            }
        }
        return defaultValue;
    }

    window.simulateScan = function() {
        const resultContainer = document.getElementById('qr-scan-result-container');
        document.getElementById('qr-elevator-id').textContent = 'ELEV-8848';
        document.getElementById('qr-elevator-location').textContent = 'å¸‚ä¸­å¿ƒAåŒº-ç¯çƒè´­ç‰©ä¸­å¿ƒ-è´§æ¢¯03';
        resultContainer.style.display = 'block';
    }
    window.confirmClockIn = function() {
        const elevatorId = document.getElementById('qr-elevator-id').textContent;
        alert(`${activeUser.name} å·²äº ${new Date().toLocaleString()} åœ¨ç”µæ¢¯ ${elevatorId} æ‰“å¡æˆåŠŸï¼\næ•°æ®å°†ç”¨äºåç»­åŒæ­¥ã€‚`);
        document.getElementById('qr-scan-result-container').style.display = 'none';
    }

    // --- MODAL & ACTION FUNCTIONS ---
    window.openAddMissingBusinessModal = function() {
        document.getElementById('add-missing-business-modal').style.display = 'block';
    };

    window.saveDetails = function(itemId) {
        let allData = [...businessData.maintenance_ops, ...businessData.maintenance_biz];
        const item = allData.find(d => d.id === itemId);
        if (item) {
            item.project = document.getElementById('detail-project').value;
            item.client = document.getElementById('detail-client').value;
            item.amount = parseFloat(document.getElementById('detail-amount').value);
            
            alert('åŸºæœ¬ä¿¡æ¯å·²æ›´æ–°ï¼');
            closeModal('details-modal');
            renderAllocationTable();
        }
    };

    function updateAllocationTotal() {
        let total = 0;
        document.querySelectorAll('#modal-allocations .ratio-input').forEach(input => {
            total += parseInt(input.value, 10) || 0;
        });
        const totalSpan = document.getElementById('alloc-total');
        totalSpan.textContent = total;
        totalSpan.style.color = total === 100 ? 'var(--change-new-text)' : 'var(--change-old-text)';
    }

    window.addEmployeeToAllocation = function() {
        const select = document.getElementById('employee-to-add');
        const employeeName = select.value;
        if (!employeeName) {
            alert("è¯·é€‰æ‹©ä¸€ä¸ªå‘˜å·¥ã€‚");
            return;
        }
        if (document.querySelector(`#modal-allocations .ratio-input[data-employee="${employeeName}"]`)) {
            alert("è¯¥å‘˜å·¥å·²åœ¨åˆ†é…åˆ—è¡¨ä¸­ã€‚");
            return;
        }

        const allocationContainer = document.getElementById('modal-allocations');
        const row = document.createElement('div');
        row.className = 'form-group allocation-row';
        row.innerHTML = `
            <span>${employeeName}</span>
            <input type="number" class="ratio-input" value="0" min="0" max="100" data-employee="${employeeName}"> %
            <button class="btn btn-sm btn-secondary" onclick="removeEmployeeFromAllocation(this, '${employeeName}')">ç§»é™¤</button>
        `;
        allocationContainer.appendChild(row);
        row.querySelector('.ratio-input').addEventListener('input', updateAllocationTotal);
        select.remove(select.selectedIndex);
        updateAllocationTotal();
    };

    window.removeEmployeeFromAllocation = function(button, employeeName) {
        const select = document.getElementById('employee-to-add');
        const option = document.createElement('option');
        option.value = employeeName;
        option.textContent = employeeName;
        select.appendChild(option);
        
        button.closest('.allocation-row').remove();
        updateAllocationTotal();
    };

    window.saveAllocation = function(itemId) {
        let total = 0;
        const newAllocation = [];
        document.querySelectorAll('#modal-allocations .ratio-input').forEach(input => {
            const ratio = parseInt(input.value, 10) || 0;
            total += ratio;
            if (ratio > 0) {
                newAllocation.push({ employee: input.dataset.employee, ratio: ratio });
            }
        });

        if (total !== 100) {
            alert(`æ€»åˆ†é…æ¯”ä¾‹å¿…é¡»ä¸º 100%ï¼Œå½“å‰ä¸º ${total}%ã€‚è¯·è°ƒæ•´ã€‚`);
            return;
        }

        let allData = [...businessData.maintenance_ops, ...businessData.maintenance_biz];
        const item = allData.find(d => d.id === itemId);
        if (item) {
            item.finalAllocation = newAllocation;
            if (item.status === 'confirmed') item.status = 'unconfirmed';
        }

        alert('åˆ†é…æ–¹æ¡ˆå·²æ›´æ–°ï¼');
        closeModal('allocation-modal');
        renderAllocationTable();
    };

    window.openAllocationModal = function(itemId) {
        closeModal('details-modal');
        let allData = [...businessData.maintenance_ops, ...businessData.maintenance_biz];
        const item = allData.find(d => d.id === itemId);
        if (!item) return;

        document.getElementById('alloc-modal-contract-id').textContent = item.contractId;
        const allocationContainer = document.getElementById('modal-allocations');
        allocationContainer.innerHTML = '';
        
        (item.finalAllocation || []).forEach(alloc => {
            const row = document.createElement('div');
            row.className = 'form-group allocation-row';
            row.innerHTML = `
                <span>${alloc.employee}</span>
                <input type="number" class="ratio-input" value="${alloc.ratio}" min="0" max="100" data-employee="${alloc.employee}"> %
                <button class="btn btn-sm btn-secondary" onclick="removeEmployeeFromAllocation(this, '${alloc.employee}')">ç§»é™¤</button>
            `;
            allocationContainer.appendChild(row);
        });

        const employeeSelect = document.getElementById('employee-to-add');
        employeeSelect.innerHTML = '';
        const allocatedEmployees = (item.finalAllocation || []).map(a => a.employee);
        employees.filter(e => !allocatedEmployees.includes(e.name)).forEach(e => {
            const option = document.createElement('option');
            option.value = e.name;
            option.textContent = e.name;
            employeeSelect.appendChild(option);
        });
        
        document.getElementById('save-allocation-btn').onclick = () => saveAllocation(itemId);
        document.getElementById('allocation-modal').style.display = 'block';
        document.querySelectorAll('#modal-allocations .ratio-input').forEach(input => {
            input.addEventListener('input', updateAllocationTotal);
        });
        updateAllocationTotal();
    };

    window.openDetailsModal = function(itemId) {
        let allData = [...businessData.maintenance_ops, ...businessData.maintenance_biz];
        const item = allData.find(d => d.id === itemId);
        const modal = document.getElementById('details-modal');
        const body = document.getElementById('details-modal-body');
        const footer = document.getElementById('details-modal-footer');
        document.getElementById('details-modal-title').textContent = `ä¸šåŠ¡è¯¦æƒ…: ${item.contractId}`;

        if (currentUserRole === 'specialist') {
            if (item.status === 'confirmed') {
                 body.innerHTML = `
                    <div class="detail-group"><label>é¡¹ç›®åç§°</label><p>${item.project}</p></div>
                    <div class="detail-group"><label>å®¢æˆ·</label><p>${item.client || ''}</p></div>
                    <div class="detail-group"><label>é‡‘é¢</label><p>${item.amount.toLocaleString()}</p></div>
                    <div class="detail-group"><label>å½“å‰åˆ†é…</label><p>${formatAllocation(item.finalAllocation)}</p></div>`;
                footer.innerHTML = `<button class="btn btn-primary" onclick="closeModal('details-modal')">å…³é—­</button>`;
            } else {
                body.innerHTML = `<div class="form-group"><label for="detail-project">é¡¹ç›®åç§°</label><input type="text" id="detail-project" value="${item.project}"></div><div class="form-group"><label for="detail-client">å®¢æˆ·</label><input type="text" id="detail-client" value="${item.client || ''}"></div><div class="form-group"><label for="detail-amount">é‡‘é¢</label><input type="number" id="detail-amount" value="${item.amount}"></div><div class="detail-group"><label>å½“å‰åˆ†é…</label><p>${formatAllocation(item.finalAllocation)}</p></div>`;
                footer.innerHTML = `<button class="btn btn-outline" onclick="closeModal('details-modal')">å–æ¶ˆ</button><button class="btn btn-secondary" onclick="saveDetails(${item.id})">ä¿å­˜åŸºç¡€ä¿¡æ¯</button><button class="btn btn-primary" onclick="openAllocationModal(${item.id})">ä¿®æ”¹åˆ†é…æ–¹æ¡ˆ</button>`;
            }
        } else {
            const myAlloc = item.finalAllocation.find(a => a.employee === activeUser.name);
            body.innerHTML = `<div class="detail-group"><label>é¡¹ç›®åç§°</label><p>${item.project}</p></div><div class="detail-group"><label>å½“å‰å®Œæ•´åˆ†é…æ–¹æ¡ˆ</label><p>${formatAllocation(item.finalAllocation)}</p></div><div class="detail-group"><label>æˆ‘çš„ææˆæ¯”ä¾‹</label><p style="font-weight: bold; color: var(--accent-primary);">${myAlloc ? myAlloc.ratio + '%' : 'N/A'}</p></div>`;
            footer.innerHTML = `<button class="btn btn-primary" onclick="closeModal('details-modal')">å…³é—­</button>`;
        }
        modal.style.display = 'block';
    };
    
    window.openModificationDetailsModal = function(reqId) {
        const req = modificationRequests.find(r => r.id === reqId);
        if (!req) return;

        const modal = document.getElementById('modification-details-modal');
        document.getElementById('mod-details-title').textContent = `å®¡æ‰¹ä¿®æ”¹ç”³è¯·: ${req.id}`;
        document.getElementById('mod-details-body').innerHTML = buildSubRowContent(req);
        
        const footer = document.getElementById('mod-details-footer');
        footer.innerHTML = `
            <button class="btn btn-outline" onclick="this.closest('.modal').style.display='none'">å–æ¶ˆ</button>
            <button class="btn btn-secondary" onclick="rejectModification('${req.id}')">é©³å›ç”³è¯·</button>
            <button class="btn btn-primary" onclick="approveModification('${req.id}')">æ‰¹å‡†ç”³è¯·</button>
        `;
        modal.style.display = 'block';
    };
    window.approveModification = function(reqId) {
        const req = modificationRequests.find(r => r.id === reqId);
        if (req) {
            req.approvalStatus = 'approved';
            alert(`ç”³è¯· ${reqId} å·²æ‰¹å‡†ã€‚`);
            closeModal('modification-details-modal');
            renderEmployeeRequestsApprovalTable();
            renderModificationProcessingTable(); 
        }
    };
    window.rejectModification = function(reqId) {
        const req = modificationRequests.find(r => r.id === reqId);
        if (req) {
            req.approvalStatus = 'rejected';
            alert(`ç”³è¯· ${reqId} å·²é©³å›ã€‚`);
            closeModal('modification-details-modal');
            renderEmployeeRequestsApprovalTable();
            renderModificationProcessingTable();
        }
    };
    
    window.openModificationModalForEmployee = function(itemId) {
        let allData = [...businessData.maintenance_ops, ...businessData.maintenance_biz];
        const item = allData.find(d => d.id === itemId);
        if (!item) return;

        const myAlloc = item.finalAllocation.find(a => a.employee === activeUser.name);
        if (!myAlloc) {
            alert('æ‚¨ä¸åœ¨æ­¤ä¸šåŠ¡çš„åˆ†é…åˆ—è¡¨ä¸­ï¼Œæ— æ³•ç”³è¯·ä¿®æ”¹ã€‚');
            return;
        }

        document.getElementById('emp-mod-contract-id').textContent = item.contractId;
        const ratioInput = document.getElementById('emp-mod-new-ratio');
        ratioInput.value = myAlloc.ratio;
        ratioInput.placeholder = `å½“å‰æ¯”ä¾‹: ${myAlloc.ratio}%`;
        document.getElementById('emp-mod-reason').value = '';

        document.getElementById('submit-employee-modification-btn').onclick = () => submitEmployeeModification(itemId);
        document.getElementById('employee-modification-modal').style.display = 'block';
    };

    function submitEmployeeModification(itemId) {
        let allData = [...businessData.maintenance_ops, ...businessData.maintenance_biz];
        const item = allData.find(d => d.id === itemId);
        const myAlloc = item.finalAllocation.find(a => a.employee === activeUser.name);

        const newRatio = parseInt(document.getElementById('emp-mod-new-ratio').value, 10);
        const reason = document.getElementById('emp-mod-reason').value.trim();

        if (isNaN(newRatio) || newRatio < 0 || newRatio > 100) {
            alert('è¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„æ¯”ä¾‹ (0-100)ã€‚');
            return;
        }
        if (!reason) {
            alert('è¯·è¾“å…¥ç”³è¯·ç†ç”±ã€‚');
            return;
        }
        if (newRatio === myAlloc.ratio) {
            alert('æ–°æ¯”ä¾‹ä¸å½“å‰æ¯”ä¾‹ç›¸åŒï¼Œæ— éœ€ä¿®æ”¹ã€‚');
            return;
        }

        const newRequestId = 'MOD-' + String(Date.now()).slice(-3);
        modificationRequests.push({
            id: newRequestId,
            businessId: itemId,
            contractId: item.contractId,
            timestamp: new Date().toISOString().split('T')[0],
            approvalStatus: 'pending',
            type: 'employee_suggestion',
            submitter: { name: activeUser.name },
            details: { from: myAlloc.ratio, to: newRatio, reason: reason }
        });

        item.status = 'modification_pending';
        alert('ä¿®æ”¹ç”³è¯·å·²æäº¤ï¼');
        closeModal('employee-modification-modal');
        renderAllocationTable();
        renderModificationProcessingTable();
    }

    window.batchConfirmItems = function() { /* ... original logic ... */ };

    // --- INIT & NAVIGATION ---
    const switchPage = (pageId) => {
        document.querySelectorAll('.nav-menu li').forEach(l => l.classList.remove('active'));
        const link = document.querySelector(`.nav-menu li[data-page="${pageId}"]`);
        if (link) link.classList.add('active');
        document.querySelectorAll('.page').forEach(p => p.classList.toggle('active', p.id === 'page-' + pageId));
        renderAll();
    };
    const renderAll = () => {
        const activePageId = document.querySelector('.page.active').id.replace('page-','');
        switch(activePageId) {
            case 'allocation': renderAllocationTable(); break;
            case 'modification-processing': renderModificationProcessingTable(); break;
            case 'employee-requests-approval': renderEmployeeRequestsApprovalTable(); break;
            case 'rules-engine': renderRulesEnginePage(); break;
            case 'clock-in': /* No render needed for this simple page */ break;
            // --- æ–°å¢ä»£ç å¼€å§‹ ---
            case 'calculation-results': renderCalculationResultsPage(); break;
            case 'calculation-analysis': renderCalculationAnalysisPage(); break;
            // --- æ–°å¢ä»£ç ç»“æŸ ---
        }
    }
    document.querySelectorAll('.nav-menu li').forEach(link => link.addEventListener('click', () => switchPage(link.dataset.page)));
    
    document.getElementById('role-switcher').addEventListener('change', (e) => { 
        const selectedValue = e.target.value; const isSpecialist = selectedValue === 'specialist';
        if (isSpecialist) { currentUserRole = 'specialist'; activeUser = { id: '000797881', name: 'æ ¸ç®—ä¸“å‘˜' }; } 
        else { currentUserRole = 'employee'; const userId = selectedValue.split('_')[1]; activeUser = employees.find(emp => emp.id === userId); }
        document.getElementById('user-name').textContent = `${activeUser.name} (${activeUser.id})`;
        
        document.querySelectorAll('.specialist-only').forEach(el => el.style.display = isSpecialist ? 'flex' : 'none');
        document.querySelectorAll('.employee-only').forEach(el => el.style.display = isSpecialist ? 'none' : 'flex');
        
        const activePageId = document.querySelector('.page.active').id.replace('page-','');
        const specialistPages = ['employee-requests-approval', 'rules-engine', 'calculation-results', 'calculation-analysis'];
        if ((!isSpecialist && specialistPages.includes(activePageId)) || (isSpecialist && activePageId === 'clock-in')) {
             switchPage('allocation'); 
        } else { renderAll(); }
    });

    document.getElementById('commission-type-switcher').addEventListener('change', e => {
        activeCommissionType = e.target.value;
        alert(`ææˆç±»å‹å·²åˆ‡æ¢ä¸º: ${e.target.options[e.target.selectedIndex].text}ã€‚\nä¸šåŠ¡åˆ—è¡¨å·²åˆ·æ–°ã€‚`);
        // --- æ–°å¢ä»£ç å¼€å§‹ ---
        // åˆ‡æ¢ä¸šåŠ¡ç±»å‹æ—¶ï¼Œåˆ·æ–°å½“å‰å¯èƒ½æ‰“å¼€çš„ä»»ä½•é¡µé¢
        const activePageId = document.querySelector('.page.active').id.replace('page-','');
        switchPage(activePageId);
        // --- æ–°å¢ä»£ç ç»“æŸ ---
    });
    
    document.querySelectorAll('.modal .close-btn').forEach(btn => btn.onclick = (e) => { e.stopPropagation(); btn.closest('.modal').style.display = 'none' });

    const themeToggle = document.getElementById('theme-toggle');
    const applyTheme = (theme) => { if (theme === 'light') { document.body.classList.add('light-mode'); themeToggle.checked = true; } else { document.body.classList.remove('light-mode'); themeToggle.checked = false; } };
    applyTheme(localStorage.getItem('theme'));
    themeToggle.addEventListener('change', function(e) { const selectedTheme = e.target.checked ? 'light' : 'dark'; localStorage.setItem('theme', selectedTheme); applyTheme(selectedTheme); });
    
    const viewModeToggle = document.getElementById('view-mode-toggle');
    const applyViewMode = (mode) => {
        if (mode === 'mobile') { document.body.classList.add('mobile-view'); document.getElementById('mobile-icon').style.display = 'none'; document.getElementById('desktop-icon').style.display = 'block';
        } else { document.body.classList.remove('mobile-view'); document.getElementById('mobile-icon').style.display = 'block'; document.getElementById('desktop-icon').style.display = 'none'; }
        renderAll();
    }
    viewModeToggle.addEventListener('click', () => {
        const newMode = document.body.classList.contains('mobile-view') ? 'desktop' : 'mobile';
        localStorage.setItem('viewMode', newMode);
        applyViewMode(newMode);
    });
    
    // Initial Load
    applyViewMode(localStorage.getItem('viewMode') || 'desktop');
    document.getElementById('role-switcher').dispatchEvent(new Event('change'));
    switchPage('home'); 
});
</script>

</body>
</html>
